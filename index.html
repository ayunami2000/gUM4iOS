<head>
<script>
var video_status = false;
  var video = document.createElement("video");
  video.setAttribute("width", 640);
  video.setAttribute("height", 480);

  var muted = document.createElement("input");
  muted.type = "checkbox";
  muted.checked = true;
  muted.onclick = function() { video.muted = muted.checked; };

  var mute = document.createElement("label");
  mute.innerHTML = "Muted";
  mute.insertBefore(muted, mute.firstChild);

  var snapshots = [];

  var audio_status = false;
  var audio = document.createElement("audio");
  audio.setAttribute("controls", true);

  var start = document.getElementById("startbuttons");
  var stop = document.getElementById("stopbuttons");

  var message = document.getElementById("message");
  var content = document.getElementById("content");
  var frames = document.getElementById("frames");
  var snapshot = document.getElementById("snapshot");

  var saved_stream = null;
  var capturing = false;
  var running = false;

function startAudioVideo() {
    video_status = true;
    audio_status = true;
    mediaConstraints = {video:true, audio:true, facingMode:(document.querySelector("#facing").checked?"user":"environment")};
    startMedia(mediaConstraints);
  }
function stopMedia() {try{
    if (video_status) {
      if (video.srcObject) {
        video.srcObject.stop();
      }
      video.srcObject = null;
      content.removeChild(video);
      controls.removeChild(mute);
      stopbuttons.removeChild(snapshot);
      snapshot.value = "Snapshot";
      frames.innerHTML = '';
      capturing = false;
      video_status = false;
    } else if (audio_status) {
      if (audio.srcObject) {
        audio.srcObject.stop();
      }
      audio.srcObject = null;
      content.removeChild(audio);
      audio_status = false;
    }
    saved_stream = null;
    stop.style.display = "none";
    start.style.display = "block";
    running = false;
}catch(e){alert(e);}
  }

  function pauseMedia() {
    if (saved_stream) {
      if (video_status) {
        video.srcObject = saved_stream;
        video.play();
      } else if (audio_status) {
        audio.srcObject = saved_stream;
        audio.play();
      }
      saved_stream = null;
    } else {
      if (video_status) {
        video.pause();
        saved_stream = video.srcObject;
        video.srcObject = null;
      } else if (audio_status) {
        audio.pause();
        saved_stream = audio.srcObject;
        audio.srcObject = null;
      }
    }
  }

  function getusermedia_error(err, params) {
    if (params.video && params.video.mediaSource) {
      if (location.protocol != "https:") {
        message.innerHTML = "<p class='error'>" + err + "</p>" +
          "<p>Screen/window sharing now requires the site be loaded from an https: URL</p>" +
          "<p>Reloading on https: in 10 seconds</p>";
        setTimeout(function() {
            window.location.href = "https:" + window.location.href.substring(window.location.protocol.length);
          }, 10000);
      } else {
        message.innerHTML = "<p class='error'>" + err + "</p>" +
          "<p>In <a href=\"about:config\">about:config</a>, please enable media.getusermedia.screensharing.enabled<br> and add this" +
          " site's domain name to media.getusermedia.screensharing.allowed_domains in about:config</p>";
      }
    } else {
        message.innerHTML = "<p class='error'>" + err + "</p>";
    }
    stopMedia();
  }

  function startMedia(param) {
    stop.style.display = "block";
    start.style.display = "none";
    var p = navigator.mediaDevices.getUserMedia(param)
      .then(function(stream) {
        message.innerHTML = "<p>Success!</p>";
        if (video_status) {
          content.appendChild(video);
          if (audio_status) {
            controls.appendChild(mute);
            video.muted = muted.checked;
          }
          video.srcObject = stream;
          video.play();
          frames.innerHTML = '';
          stopbuttons.appendChild(snapshot);
        } else if (audio_status) {
          content.appendChild(audio);
          audio.srcObject = stream;
          audio.play();
        }
        running = true;
      })
    .catch(function (err) { getusermedia_error(err, param); });
  }
</script>
</head>
<body>
    <div id="startbuttons">
      <input value="Begin Test" onclick="startAudioVideo();pauseMedia();" type="button">
    <input id="facing" type="checkbox" checked>Selfie mode
    </div>
    <div id="images">
       <div id="content"></div>
       <div id="controls"></div>
       <div id="frames"></div>
       <div id="fps"></div>
    </div>
    <div id="message"></div>
    <div style="display: none;" id="stopbuttons">
      <input value="Stop" onclick="stopMedia();" type="button">
      <input value="Pause/Play" onclick="pauseMedia();" type="button">
      <input id="snapshot" value="Snapshot" onclick="startSnapshot();" type="button">
    </div>
</body>
